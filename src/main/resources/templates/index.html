<!DOCTYPE html>
<html>
<head>
<title>Source Server Manager</title>
<link
	rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
	integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
	crossorigin="anonymous"></link>
<link
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
	crossorigin="anonymous">
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/css/bootstrap-dialog.min.css"
	rel="stylesheet"></link>
<script
	type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
	integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
	crossorigin="anonymous"></script>
<script
	type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.0.3/vue.min.js"></script>
<script
	type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.16.4/lodash.min.js"></script>
<script
	type="text/javascript"
	src="https:////cdn.jsdelivr.net/sockjs/1/sockjs.min.js"></script>
<script
	type="text/javascript"
	src="http://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script
	type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.2/moment-with-locales.min.js"></script>
<script
	type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/js/bootstrap-dialog.min.js"></script>
</head>
<body>
	<div
		v-if="authenticated"
		id="app"
		class="container">
		<div class="row">
			<div class="col-xs-12 col-md-5">
				<div class="panel panel-primary">
					<div class="panel-heading">
						<h3 class="panel-title">Server Info</h3>
					</div>
					<div class="panel-body">
						<form class="form-horizontal">
							<div class="form-group-sm">
								<label class="col-sm-3 control-label">Hostname:</label>
								<div class="col-sm-9">
									<p
										class="form-control-static"
										v-text="server.serverName" />
								</div>
							</div>
							<div class="form-group-sm">
								<label class="col-sm-3 control-label">Game:</label>
								<div class="col-sm-9">
									<p
										class="form-control-static"
										v-text="server.gameDescription" />
								</div>
							</div>
							<div class="form-group-sm">
								<label class="col-sm-3 control-label">Version:</label>
								<div class="col-sm-9">
									<p
										class="form-control-static"
										v-text="server.gameVersion" />
								</div>
							</div>
							<div class="form-group-sm">
								<label class="col-sm-3 control-label">Password:</label>
								<div class="col-sm-9">
									<p
										class="form-control-static"
										v-text="server.serverName ? server.passwordProtected ? 'Yes' : 'No': ''" />
								</div>
							</div>
							<div class="form-group-sm">
								<label class="col-sm-3 control-label">Map:</label>
								<div class="col-sm-9">
									<p
										class="form-control-static"
										v-text="server.mapName" />
								</div>
							</div>
							<div class="form-group-sm">
								<label class="col-sm-3 control-label">Maxplayers:</label>
								<div class="col-sm-9">
									<p
										class="form-control-static"
										v-text="server.maxPlayers" />
								</div>
							</div>
							<div class="form-group-sm">
								<label class="col-sm-3 control-label">Tags:</label>
								<div class="col-sm-9">
									<p
										class="form-control-static"
										v-text="server.serverTags" />
								</div>
							</div>
							<div class="form-group">
								<a
									v-if="server.serverPort"
									v-bind:href="'steam://connect/' + window.location.hostname + ':' + server.serverPort"
									class="col-sm-3 control-label">Connect</a>
							</div>
						</form>
					</div>
				</div>
			</div>
			<div class="col-xs-12 col-md-7">
				<div class="panel panel-primary">
					<div class="panel-heading">
						<h3 class="panel-title">Players</h3>
					</div>
					<table class="table table-hover table-responsive">
						<thead class="thead-inverse">
							<tr>
								<th>ID</th>
								<th>Name</th>
								<th>SteamID</th>
								<th>Score</th>
								<th>IP</th>
								<th>Time</th>
								<th>Ping</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							<tr
								v-for="player in _.orderBy(players, ['score', 'connectTime'], ['desc', 'desc'])"
								:key="player.connectTime"
								v-bind:class="{success: player.ping <= 150, warning: player.ping > 150 && player.ping <= 250, danger: player.ping > 250}">
								<td v-text="player.realId" />
								<td v-text="player.name" />
								<td v-text="player.steamId" />
								<td v-text="player.score" />
								<td v-text="player.ipAddress" />
								<td v-text="moment(new Date(1970, 1, 1, 0, 0, player.connectTime.toString().replace(/\..*/gi, ''), 0)).format('HH:mm:ss')" />
								<td v-text="player.ping" />
								<td>
									<button
										type="button"
										v-on:click="playerOptions(player)"
										class="btn text-center icons-group"
										style="padding: 4px 4px 4px 4px;">
										<span
											class="glyphicon glyphicon-option-vertical"
											aria-hidden="true"></span>
									</button>
								</td>
							</tr>
							<tr>
								<th colspan="6" />
								<th>Total</th>
								<th v-text="players.length"></th>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-12">
				<div class="panel panel-primary">
					<div class="panel-heading">
						<h3 class="panel-title">Console</h3>
					</div>
					<div class="panel-body">
						<textarea
							id="console-text"
							readonly="readonly"
							draggable="false"
							rows="15"
							class="col-sm-12"
							style="text-align: left; background-color: #000; font-family: 'Courier New'; color: #fff; resize: none; border-width: 0px; border: none; outline-width: 0;">
							</textarea>
						<input
							v-on:keydown.enter="sendCommand($(event.currentTarget).val()); $(event.currentTarget).val('')"
							class="col-sm-12"
							type="text"
							style="background-color: #000; font-family: 'Courier New'; color: #fff; border-width: 0px; border: none; outline-width: 0;"
							placeholder=">">
					</div>
				</div>
			</div>
		</div>
		<div
			id="player-options-content"
			v-show="false"
			class="">
			<div
				class="btn-group-vertical"
				style="width: 100%"
				role="group">
				<button
					v-on:click="askInput('Send message to '+selectedPlayer.name, function(input) {sendCommand(('sm_psay #'+selectedPlayer.realId+' '+input));})"
					type="button"
					class="btn btn-success">Send private message</button>
				<button
					v-on:click="sendCommand('sm_mute #'+selectedPlayer.realId)"
					type="button"
					class="btn btn-primary">Mute</button>
				<button
					v-on:click="sendCommand('sm_unmute #'+selectedPlayer.realId)"
					type="button"
					class="btn btn-primary">Unmute</button>
				<button
					v-on:click="sendCommand('sm_slay #'+selectedPlayer.realId)"
					type="button"
					class="btn btn-warning">Kill</button>
				<button
					v-on:click="askInput('Kick '+selectedPlayer.name, function(input) {sendCommand('sm_kick #'+selectedPlayer.realId);})"
					type="button"
					class="btn btn-danger">Kick</button>
				<button
					v-on:click="askInput('Ban '+selectedPlayer.name, function(input) {endCommand('sm_ban #'+selectedPlayer.realId)})"
					type="button"
					class="btn btn-danger">Ban</button>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		$(document).ready(function() {
			$.get("authenticated", function(authenticated) {
				if (authenticated) {
					afterAuth();
				} else {
					authenticate();
				}
			});
		});

		var vm = new Vue({
			el : "#app",
			data : {
				authenticated : false,
				server : {},
				selectedPlayer : {},
				players : [],
			},
			methods : {
				refreshServerInfo : function() {
					var self = this;
					$.getJSON("serverInfo", function(data) {
						vm.server = data;
					});
				},
				refreshPlayers : function() {
					$.getJSON("players", function(data) {
						vm.players = data;
					});
				},
				sendCommand : function(command) {
					$.get("sendCommand", {
						command : command
					}, function(data) {
						var $console = $("#console-text");
						$console.text($console.text() + "\n" + data);
						$console.scrollTop($console[0].scrollHeight);
					});
				},
				playerOptions : function(player) {
					BootstrapDialog.show({
						type : BootstrapDialog.TYPE_PRIMARY,
						title : player.name,
						size : BootstrapDialog.SIZE_SMALL,
						message : $('#player-options-content').show(),
						autodestroy : false,
						onshow : function(dialogRef) {
							vm.selectedPlayer = player;
						},
						onhide : function(dialogRef) {
							vm.selectedPlayer = null;
						},
					});
				},
				askInput : function(title, callback) {
					BootstrapDialog.show({
						type : BootstrapDialog.TYPE_PRIMARY,
						title : title,
						size : BootstrapDialog.SIZE_SMALL,
						message : '<input type="text" class="form-control">',
						onhide : function(dialogRef) {
							var input = dialogRef.getModalBody().find('input')
									.val();
							if (input) {
								callback(input);
							}
						},
						buttons : [ {
							label : 'Ok',
							action : function(dialogRef) {
								dialogRef.close();
							}
						} ]
					});
				}
			}
		});

		function authenticate() {
			BootstrapDialog
					.show({
						type : BootstrapDialog.TYPE_PRIMARY,
						title : 'Rcon password',
						size : BootstrapDialog.SIZE_SMALL,
						message : '<input id="password" type="password" placeholder="Password" class="form-control"><br><input id="port" type="text" placeholder="Server port: 27015" class="form-control">',
						onhide : function(dialogRef) {
							var password = dialogRef.getModalBody().find(
									'#password').val();
							var port = dialogRef.getModalBody().find('#port')
									.val();
							if (password) {
								$.get('auth', {
									rconPassword : password,
									serverPort : port
								}, function(data) {
									afterAuth();
								});
							}
						},
						buttons : [ {
							label : 'Authenticate',
							action : function(dialogRef) {
								dialogRef.close();
							}
						} ]
					});
		}

		function afterAuth() {

			vm.authenticated = true;
			vm.refreshServerInfo();
			vm.refreshPlayers();

			setInterval(function() {
				vm.refreshServerInfo();
			}, 5000);

			setInterval(function() {
				vm.refreshPlayers();
			}, 2000);

			var messages = $("#messages");
			var socket = new SockJS("/ws");
			var stompClient = Stomp.over(socket);
			stompClient.connect({}, function(frame) {
				stompClient.subscribe("/topic/console",
						function(data) {
							var message = data.body;
							messages.append($("<tr/>").append(
									$("<td/>").text(message)));
						});
			});
		}
	</script>
</body>
</html>